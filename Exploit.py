#!/usr/bin/env python3
# BT Car Hacking Defalt
# Includes: Auto Fingerprint DB v2 + Co-Channel Map + Intent Engine + Radar Mode

import os, re, json, asyncio, subprocess, time
from datetime import datetime
from bleak import BleakScanner, BleakClient

# ---------------- COLORS ----------------
RED="\033[91m"; GREEN="\033[92m"; CYAN="\033[96m"; YEL="\033[93m"; RESET="\033[0m"

# ---------------- BANNER ----------------
def banner():
    print(GREEN+r"""



******************************************************************
*$$$$$$$\ $$$$$$$$\        $$$$$$\                               *
*$$  __$$\\__$$  __|      $$  __$$\                              *
*$$ |  $$ |  $$ |         $$ /  \__| $$$$$$\   $$$$$$\           *
*$$$$$$$\ |  $$ |         $$ |       \____$$\ $$  __$$\          *
*$$  __$$\   $$ |         $$ |       $$$$$$$ |$$ |  \__|         *
*$$ |  $$ |  $$ |         $$ |  $$\ $$  __$$ |$$ |               *
*$$$$$$$  |  $$ |         \$$$$$$  |\$$$$$$$ |$$ |               *
*\_______/   \__|          \______/  \_______|\__|               *
*                                                                *
*                                                                *
*                                                                *
*$$\   $$\                     $$\       $$\                     *
*$$ |  $$ |                    $$ |      \__|                    *
*$$ |  $$ | $$$$$$\   $$$$$$$\ $$ |  $$\ $$\ $$$$$$$\   $$$$$$\  *
*$$$$$$$$ | \____$$\ $$  _____|$$ | $$  |$$ |$$  __$$\ $$  __$$\ *
*$$  __$$ | $$$$$$$ |$$ /      $$$$$$  / $$ |$$ |  $$ |$$ /  $$ |*
*$$ |  $$ |$$  __$$ |$$ |      $$  _$$<  $$ |$$ |  $$ |$$ |  $$ |*
*$$ |  $$ |\$$$$$$$ |\$$$$$$$\ $$ | \$$\ $$ |$$ |  $$ |\$$$$$$$ |*
*\__|  \__| \_______| \_______|\__|  \__|\__|\__|  \__| \____$$ |*
*                                                      $$\   $$ |*
*                                                      \$$$$$$  |*
*                                                       \______/ *
*$$$$$$$\             $$$$$$\           $$\   $$\                *
*$$  __$$\           $$  __$$\          $$ |  $$ |               *
*$$ |  $$ | $$$$$$\  $$ /  \__|$$$$$$\  $$ |$$$$$$\              *
*$$ |  $$ |$$  __$$\ $$$$\     \____$$\ $$ |\_$$  _|             *
*$$ |  $$ |$$$$$$$$ |$$  _|    $$$$$$$ |$$ |  $$ |               *
*$$ |  $$ |$$   ____|$$ |     $$  __$$ |$$ |  $$ |$$\            *
*$$$$$$$  |\$$$$$$$\ $$ |     \$$$$$$$ |$$ |  \$$$$  |           *
*\_______/  \_______|\__|      \_______|\__|   \____/            *
******************************************************************






""" + RESET)

# ---------------- HELPERS ----------------
def clean(name):
    if not name: return "unknown_device"
    return re.sub(r"[^A-Za-z0-9_]+","_", name)

def make_folder(n):
    p=f"report/{n}"
    os.makedirs(p, exist_ok=True)
    return p

def save(folder, fname, content):
    with open(os.path.join(folder, fname),"w") as f:
        f.write(content)

# ============================================================
# AUTOMOTIVE FINGERPRINT DATABASE v2 (CONSERVATIVE MODE)
# ============================================================
AUTO_DB = {
    "28:9F:04": "KMC / JAC / Chery Automotive Unit (Chinese Platform)",
    "A4:C1:38": "JAC Motors",
    "40:45:DA": "Chery Automotive Module",

    # Korean
    "00:1A:79": "Hyundai Mobis",
    "00:13:E0": "Kia Motors",

    # Japanese
    "00:16:6C": "Honda",
    "00:12:1C": "Toyota",
    "00:26:7E": "Mazda",
    "00:0E:F3": "Nissan",

    # European
    "00:1B:63": "BMW",
    "00:07:04": "Audi",
    "00:1E:AE": "Volkswagen",
    "00:09:DD": "Mercedes-Benz",
}

AUTO_UUID_CLUSTERS = {
    "0000fff0": "Automotive Diagnostics",
    "0000180a": "DeviceInfo (Car)",
    "0000180f": "Battery/Power (Car Head Units)"
}

# ============================================================
# CONSERVATIVE AUTOMOTIVE CLASSIFIER
# ============================================================
def classify_conservative(name, mac, adv):
    prefix = mac.upper()[0:8]
    n = (name or "").lower()

    # 1) Direct OUI match
    if prefix in AUTO_DB:
        return AUTO_DB[prefix]

    # 2) BLE UUID cluster match
    if adv and adv.service_uuids:
        for u in adv.service_uuids:
            uid = u.lower()[0:8]
            if uid in AUTO_UUID_CLUSTERS:
                return "Automotive BLE Module (UUID Verified)"

    # 3) Strict automotive names
    strict_names = ["car", "auto", "bt-car", "car-bt", "car_"]
    if any(sn in n for sn in strict_names):
        return "Automotive Bluetooth Device"

    # 4) TPMS
    if adv and adv.manufacturer_data:
        for k,v in adv.manufacturer_data.items():
            if len(v)==3:
                return "TPMS BLE Sensor"

    # 5) OBD-II strict
    if adv and adv.service_uuids:
        if any(u.startswith("0000fff0") for u in adv.service_uuids):
            return "OBD-II BLE Scanner"

    return "Generic Bluetooth Device"

# ============================================================
# DETECTORS
# ============================================================
def detect_tpms(adv):
    if adv and adv.manufacturer_data:
        for k,v in adv.manufacturer_data.items():
            if len(v)==3: return True
    return False

def detect_obd(adv):
    if adv and adv.service_uuids:
        return any(u.startswith("0000fff0") for u in adv.service_uuids)
    return False

# ============================================================
# CLASSIC SCAN
# ============================================================
def classic_scan():
    print(CYAN + "\n[+] Classic Scan..." + RESET)
    out = subprocess.getoutput("hcitool scan")
    dev=[]
    for line in out.split("\n"):
        if ":" in line:
            parts=line.split("\t")
            if len(parts)>=2:
                addr=parts[0].strip()
                name=parts[-1].strip()
                dev.append((addr,name,None,"classic"))
    return dev

# ============================================================
# BLE SCAN
# ============================================================
async def ble_scan():
    print(CYAN+"\n[+] BLE Scan..."+RESET)
    lst=[]
    devs=await BleakScanner.discover()
    for d in devs:
        lst.append((d.address, d.name or d.address, d.rssi, "ble"))
        print(f"[BLE] {d.name} ({d.address}) RSSI={d.rssi}")
    return lst

# ============================================================
# GATT DUMP
# ============================================================
async def gatt_dump(addr, folder):
    print(CYAN+"\n[+] GATT Dump..."+RESET)
    try:
        async with BleakClient(addr) as cli:
            svcs=await cli.get_services()
            out=""
            for s in svcs:
                out+=f"\nService {s.uuid}\n"
                for c in s.characteristics:
                    out+=f"  - Char {c.uuid} props={c.properties}\n"
            save(folder,"gatt.txt",out)
            print(GREEN+"[✓] GATT Saved"+RESET)
    except Exception as e:
        print(RED,f"[!] {e}",RESET)

# ============================================================
# METADATA INSPECTOR
# ============================================================
async def metadata_inspector(addr, duration=None):
    print(CYAN+"\n[+] Metadata Inspector..." + RESET)

    def cb(dev,adv):
        if dev.address.lower()!=addr.lower(): return
        print(GREEN+"\n--- METADATA ---"+RESET)
        print("Name:",dev.name)
        print("RSSI:",dev.rssi)
        print("UUIDs:",adv.service_uuids)
        print("MFR:",adv.manufacturer_data)

    scanner=BleakScanner(cb)
    await scanner.start()

    try:
        if duration:
            await asyncio.sleep(duration)
        else:
            while True:
                await asyncio.sleep(0.3)
    except KeyboardInterrupt:
        pass

    await scanner.stop()

# ============================================================
# ADVERTISEMENT LOGGER
# ============================================================
async def advertisement_logger(addr, folder, duration=None):
    print(CYAN+"\n[+] AD Logger..." + RESET)
    logfile=os.path.join(folder,"advertisements.txt")

    def cb(dev,adv):
        if dev.address.lower()!=addr.lower(): return
        with open(logfile,"a") as f:
            f.write(f"{datetime.now()} | RSSI={dev.rssi} | UUIDs={adv.service_uuids}\n")

    scanner=BleakScanner(cb)
    await scanner.start()

    try:
        if duration: await asyncio.sleep(duration)
        else:
            while True: await asyncio.sleep(0.3)
    except KeyboardInterrupt:
        pass

    await scanner.stop()

# ============================================================
# HEATMAP LOGGER
# ============================================================
async def heatmap_logger(addr, folder, duration):
    print(CYAN+"\n[+] Heatmap..." + RESET)
    vals=[]

    async def one():
        devs=await BleakScanner.discover()
        for d in devs:
            if d.address.lower()==addr.lower(): return d.rssi

    end=time.time()+duration
    while time.time()<end:
        r=await one()
        if r: vals.append(str(r))
        await asyncio.sleep(0.3)

    save(folder,"heatmap.txt","\n".join(vals))

# ============================================================
# RSSI WAVEFORM
# ============================================================
async def waveform(addr, duration=None):
    print(CYAN+"\n[+] RSSI Waveform..." + RESET)

    def bar(r): return "█"*max(1,int((100+r)/3))

    async def one():
        devs=await BleakScanner.discover()
        for d in devs:
            if d.address.lower()==addr.lower(): return d.rssi

    try:
        if duration:
            end=time.time()+duration
            while time.time()<end:
                r=await one()
                if r: print(f"RSSI {r} | {bar(r)}")
                await asyncio.sleep(0.25)
        else:
            while True:
                r=await one()
                if r: print(f"RSSI {r} | {bar(r)}")
                await asyncio.sleep(0.25)
    except KeyboardInterrupt:
        pass

# ============================================================
# CO-CHANNEL MAP
# ============================================================
async def co_channel_map(duration=5):
    print(CYAN+"\n[+] Co-Channel Map (CH37/38/39)"+RESET)
    counter={37:0,38:0,39:0}

    def cb(dev,adv):
        if adv and adv.channel in counter:
            counter[adv.channel]+=1

    scanner=BleakScanner(cb)
    await scanner.start()
    await asyncio.sleep(duration)
    await scanner.stop()

    print("\nChannel Traffic:")
    for ch in [37,38,39]:
        val=counter[ch]
        bar="█"*(val//2)
        print(f"CH{ch}: {bar} ({val})")

# ============================================================
# BLE INTENT ENGINE
# ============================================================
def analyze_intent(adv):
    if not adv:
        return "No special behavior"

    intents=[]

    # Media sync in automotive HUs
    if "0000180f" in str(adv.service_uuids):
        intents.append("Media Sync or Car Audio State")

    # OBD-II polling
    if detect_obd(adv):
        intents.append("OBD-II Diagnostic Polling")

    # TPMS
    if detect_tpms(adv):
        intents.append("TPMS Pressure Burst")

    if not intents:
        return "No special behavior"

    return ", ".join(intents)

# ============================================================
# VEHICLE RADAR MODE
# ============================================================
async def vehicle_radar(addr, duration=10):
    print(CYAN+"\n[+] Vehicle Radar Mode (RSSI Drift)"+RESET)
    vals=[]

    async def one():
        devs=await BleakScanner.discover()
        for d in devs:
            if d.address.lower()==addr.lower(): return d.rssi

    end=time.time()+duration
    while time.time()<end:
        r=await one()
        if r: vals.append(r)
        await asyncio.sleep(0.5)

    if len(vals)<3:
        print(RED+"Insufficient data."+RESET); return

    drift=vals[-1]-vals[0]
    avg=sum(vals)/len(vals)

    print(f"\nRSSI avg: {avg:.2f}")
    print(f"Drift: {drift}")

    if drift>6:
        print(GREEN+"Movement: Approaching"+RESET)
    elif drift<-6:
        print(RED+"Movement: Leaving"+RESET)
    else:
        print(YEL+"Movement: Stationary"+RESET)

# ============================================================
# TRIANGULATION (HTML)
# ============================================================
async def triangulation(addr, folder, interval=0.5):
    print(CYAN+"\n[+] Triangulation..."+RESET)
    outfile=os.path.join(folder,"triangulation.html")

    def bar(r):
        if r>-60: c="#39ff14"
        elif r>-75: c="#ffd000"
        else: c="#ff0033"
        w=max(10,int((100+r)*1.8))
        return f"<div style='width:{w}px;height:22px;background:{c};'></div>"

    async def one():
        devs=await BleakScanner.discover()
        for d in devs:
            if d.address.lower()==addr.lower(): return d.rssi

    try:
        while True:
            r=await one()
            if r:
                html=f"""
                <html><body style='background:black;color:#39ff14;font-family:Consolas;'>
                <h2>Real-Time BLE RSSI</h2>
                <p>RSSI: {r}</p>
                {bar(r)}
                <p>{datetime.now()}</p>
                </body></html>
                """
                with open(outfile,"w") as f:
                    f.write(html)
            await asyncio.sleep(interval)
    except KeyboardInterrupt:
        pass

# ============================================================
# HTML REPORT
# ============================================================
def generate_report(folder, name, addr, vend, category):
    html=f"""
    <html>
    <body style='background:black;color:#39ff14;font-family:Consolas;'>
    <h1>Cyberpunk Device Report</h1>
    <p>Name: {name}</p>
    <p>MAC: {addr}</p>
    <p>Vendor: {vend}</p>
    <p>Category: {category}</p>
    <p>Generated: {datetime.now()}</p>
    </body>
    </html>
    """
    with open(os.path.join(folder,f"{name}.html"),"w") as f:
        f.write(html)

# ============================================================
# MAIN MENU
# ============================================================
async def main_menu():
    banner()
    print(CYAN+"Scanning Bluetooth..."+RESET)

    classic = classic_scan()
    ble = await ble_scan()
    devices = classic + ble

    if not devices:
        print(RED+"No devices found."+RESET)
        return

    print(GREEN+"\nDetected:"+RESET)
    for i,(a,n,r,t) in enumerate(devices):
        rs=f"RSSI={r}" if r else ""
        print(f"{i+1}. {n} ({a}) [{t}] {rs}")

    while True:
        ch=input(YEL+"\nSelect device: "+RESET).strip()
        if ch.isdigit() and 1<=int(ch)<=len(devices):
            idx=int(ch)-1; break
        print(RED+"Invalid."+RESET)

    addr,name,rssi,typ = devices[idx]
    cname=clean(name)
    folder=make_folder(cname)

    # Get adv metadata
    adv_data=None
    devs=await BleakScanner.discover()
    for d in devs:
        if d.address.lower()==addr.lower():
            adv_data=d.metadata.get("advertisement_data")

    vend = AUTO_DB.get(addr.upper()[0:8], "Unknown Vendor")
    category = classify_conservative(name, addr, adv_data)

    print(GREEN+f"Vendor: {vend}"+RESET)
    print(GREEN+f"Category: {category}"+RESET)

    save(folder,"device_info.txt",f"{name}\n{addr}\n{vend}\n{category}\n")

    # ---------------- MENU ----------------
    while True:
        print(CYAN+"""
========= MENU =========
1. GATT Dump
2. Advertisement Logger
3. Metadata Inspector
4. Heatmap Logger
5. RSSI Waveform
6. HTML Triangulation
7. Generate HTML Report
8. Co-Channel Map
9. BLE Intent Analysis
10. Vehicle Radar Mode
11. Exit
========================
""" + RESET)

        op=input("Choose: ").strip()

        if op=="1":
            if typ!="ble": print(RED+"Only BLE supports GATT."+RESET); continue
            await gatt_dump(addr,folder)

        elif op=="2":
            t=input("Timed? y/n: ").lower()
            if t=="y":
                sec=int(input("Seconds: "))
                await advertisement_logger(addr,folder,sec)
            else:
                await advertisement_logger(addr,folder)

        elif op=="3":
            t=input("Timed? y/n: ").lower()
            if t=="y":
                sec=int(input("Seconds: "))
                await metadata_inspector(addr,sec)
            else:
                await metadata_inspector(addr)

        elif op=="4":
            sec=int(input("Seconds: "))
            await heatmap_logger(addr,folder,sec)

        elif op=="5":
            t=input("Timed? y/n: ").lower()
            if t=="y":
                sec=int(input("Seconds: "))
                await waveform(addr,sec)
            else:
                await waveform(addr)

        elif op=="6":
            print(GREEN+"Open triangulation.html in browser."+RESET)
            await triangulation(addr,folder,0.5)

        elif op=="7":
            generate_report(folder,cname,addr,vend,category)

        elif op=="8":
            sec=int(input("Seconds: "))
            await co_channel_map(sec)

        elif op=="9":
            print("\nIntent:", analyze_intent(adv_data))

        elif op=="10":
            sec=int(input("Seconds: "))
            await vehicle_radar(addr,sec)

        elif op=="11":
            break

        else:
            print(RED+"Invalid."+RESET)

# ============================================================
# ENTRY
# ============================================================
if __name__=="__main__":
    try:
        asyncio.run(main_menu())
    except KeyboardInterrupt:
        print(RED+"\nStopped."+RESET)
